name: Deploy to Truenas 112
run-name: ${{ gitea.actor }} is testing out Gitea Actions üöÄ
on:
  push:
  workflow_dispatch:

env:
  DOCKER_LOCAL_HOST: 10.25.0.98:15050
  MQTT_BROKER: 10.25.0.112
  IS_DEV_BRANCH: "false"
  TRUENAS_DEPLOY: "true"
  DOCKER_DEPLOY: "false"
  APP_PORT: 9095

jobs:
  Explore-Gitea-Actions:
    runs-on: ubuntu-latest
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ gitea.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by Gitea!"
      - run: echo "üîé The name of your branch is ${{ gitea.ref }} and your repository is ${{ gitea.repository }}."

      # Step to sanitize the repository name
      - name: Sanitize Repository Name
        id: sanitize_repo_name
        run: |
          REPO_FULL_NAME="${{ gitea.repository }}"  # Example: "owner/repository"
          
          # Extract only the repository name
          REPO_NAME=$(echo "$REPO_FULL_NAME" | awk -F/ '{print $2}')
          
          # Sanitize the repository name
          SANITIZED_NAME=$(echo "$REPO_NAME" | tr -cd '[:alnum:]' | tr '[:upper:]' '[:lower:]')
          
          echo "Original Repository Name: $REPO_NAME"
          echo "Sanitized Repository Name: $SANITIZED_NAME"
          
          echo "::set-output name=sanitized_name::$SANITIZED_NAME"

      # Set environment variables dynamically based on sanitized name
      - name: Set Environment Variables
        run: |
          echo "IMAGE_NAME=${{ steps.sanitize_repo_name.outputs.sanitized_name }}" >> $GITHUB_ENV
          echo "DEPLOYMENT_NAME=${{ steps.sanitize_repo_name.outputs.sanitized_name }}" >> $GITHUB_ENV

      # Install Node.js (if required)
      - name: Install Node.js
        run: |
          sudo apt update
          sudo apt install -y nodejs npm

      # Check out the repository code
      - name: Check out Repository Code
        uses: actions/checkout@v4


      # Set up Python environment
      - name: Set up Python 3 and Install Dependencies
        run: |
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip requests paramiko

      # Prune unused Docker images
      - name: Prune Unused Docker Images
        run: |
          echo "üîç Cleaning up unused Docker images..."
          docker image prune -af --filter "until=24h"
          echo "üóëÔ∏è Old Docker images cleaned up successfully!"

      - name: Build, Tag & Push Docker Image with .version
        run: |
          echo "üîß Preparing .version file..."
          
          # Extract branch name (remove refs/heads/)
          BRANCH_NAME=$(echo "${{ gitea.ref }}" | sed 's|refs/heads/||')
          
          # Get last 4 chars of the commit SHA
          SHORT_SHA=$(echo "${{ gitea.sha }}" | tail -c 5)
          
          # Build version string
          # VERSION="$BRANCH_NAME-$SHORT_SHA"
          VERSION="$BRANCH_NAME-${{ gitea.run_number }}"

          # Write to .version file
          echo "$VERSION" > .version
          echo "Generated version: $VERSION"
          ls -latr
          echo "üì¶ Building Docker image..."
          docker build -t $DOCKER_LOCAL_HOST/${{ env.IMAGE_NAME }}:latest .

          echo "üì§ Pushing Docker image to $DOCKER_LOCAL_HOST..."
          docker push $DOCKER_LOCAL_HOST/${{ env.IMAGE_NAME }}:latest

          echo "‚úÖ Docker image pushed with version $VERSION"

      # Generate docker-compose.yaml file
      - name: Generate docker-compose.yaml
        run: |
          source venv/bin/activate
          python3 .gitea/.scripts/create_docker_compose.py --app "${{ env.IMAGE_NAME }}" --host-port "${{ env.APP_PORT }}"

      # Upload the generated docker-compose.yaml as an artifact
      - name: Upload docker-compose artifact
        uses: actions/upload-artifact@v3 # Changed from @v4 to @v1
        with:
          name: docker-compose-${{ env.IMAGE_NAME }}
          path: docker-compose.yaml

      # Check Docker Registry for Image (uses DOCKER_LOCAL_HOST)
      - name: Check Docker Registry for Image
        env:
          REGISTRY: ${{ env.DOCKER_LOCAL_HOST }}
          IMAGE: ${{ env.IMAGE_NAME }}
        run: |
          # Ensure jq is available
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          response=$(curl -sf "http://$REGISTRY/v2/_catalog")
          echo "$response" | jq .

          if echo "$response" | jq -e --arg image "$IMAGE" '.repositories | index($image)' > /dev/null; then
            echo "{ \"repositories\": [\"$IMAGE\"] }"
          else
            echo "Error: '$IMAGE' repository not found in registry catalog at $REGISTRY"
            exit 1
          fi


      # Redeploy on TrueNAS
      - name: Redeploy on TrueNAS
        if: ${{ env.TRUENAS_DEPLOY == 'true' && env.IS_DEV_BRANCH == 'false' }}
        run: |
          curl http://10.25.0.112:8100/api/truenas/redeploy/${{ env.DEPLOYMENT_NAME }}
          curl http://10.25.0.112:8100/api/truenas/redeploy/${{ env.DEPLOYMENT_NAME }}?host_override=10.25.0.98

      # Redeploy on Docker
      - name: Redeploy on Docker
        if: ${{ env.DOCKER_DEPLOY == 'true' && env.IS_DEV_BRANCH == 'false' }}
        run: |
          set -e  # Exit immediately if any command exits with a non-zero status
          source venv/bin/activate
          if ! python3 .gitea/.scripts/docker.py; then
            echo "‚ùå Deployment script failed!"
            exit 1
          fi

      # Print the final job status
      - run: echo "üçè This job's status is ${{ job.status }}."

      # Send notification via Python script
      - name: Send notification to Gotify
        if: always()
        run: |
          source venv/bin/activate
          python3 .gitea/.scripts/notify.py "${{ gitea.ref }}" "${{ job.status }}" "${{ env.IMAGE_NAME }}"