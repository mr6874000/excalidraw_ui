name: Build and Push to GHCR
run-name: ${{ github.actor }} is building for GHCR üöÄ
on:
  push:
  workflow_dispatch:

env:
  # 1. CHANGE THIS to your GitHub Username (lowercase)
  GHCR_OWNER: mr6874000 
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Check out Repository Code
        uses: actions/checkout@v4

      # Log in to GitHub Container Registry
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.GHCR_OWNER }}
          password: ${{ secrets.GH_PAT }}

      - name: Sanitize Repository Name
        id: sanitize
        run: |
          # GHCR requires lowercase names
          REPO_NAME=$(echo "${{ github.repository }}" | awk -F/ '{print $2}' | tr '[:upper:]' '[:lower:]')
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT

      - name: Build and Push Image
        run: |
          # Extract branch and versioning
          BRANCH_NAME=$(echo "${{ github.ref }}" | sed 's|refs/heads/||' | tr '[:upper:]' '[:lower:]')
          VERSION="$BRANCH_NAME-${{ github.run_number }}"
          
          # Full Image Path: ghcr.io/owner/repository
          IMAGE_PATH="${{ env.REGISTRY }}/${{ env.GHCR_OWNER }}/${{ steps.sanitize.outputs.repo_name }}"
          
          echo "üì¶ Building image: $IMAGE_PATH"
          
          # Build and Tag
          docker build -t $IMAGE_PATH:latest -t $IMAGE_PATH:$VERSION .
          
          echo "üì§ Pushing to GitHub Container Registry..."
          docker push $IMAGE_PATH:latest
          docker push $IMAGE_PATH:$VERSION
          
          # Save for next steps if needed
          echo "FINAL_IMAGE=$IMAGE_PATH:$VERSION" >> $GITHUB_ENV

      - name: Final Status
        run: echo "üçè Successfully pushed ${{ env.FINAL_IMAGE }} to GHCR."